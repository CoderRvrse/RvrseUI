# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

# RvrseUI â€“ Maintainer Notes (v4.0.0)

> **âš ï¸ CRITICAL: Read this entire document before making ANY changes to the codebase.**
> This file documents the architecture, build system, common pitfalls, and strict workflows that MUST be followed.

---

## ðŸ—ï¸ Architecture Overview

### File Structure
```
RvrseUI/
â”œâ”€â”€ src/                      # âœ… SOURCE OF TRUTH - Edit these files
â”‚   â”œâ”€â”€ Version.lua           # Version metadata
â”‚   â”œâ”€â”€ Debug.lua             # Debug logging system
â”‚   â”œâ”€â”€ Obfuscation.lua       # Name obfuscation for anti-detection
â”‚   â”œâ”€â”€ Theme.lua             # Dark/Light palettes
â”‚   â”œâ”€â”€ Animator.lua          # Spring animations
â”‚   â”œâ”€â”€ State.lua             # Global state management
â”‚   â”œâ”€â”€ Config.lua            # Persistence system
â”‚   â”œâ”€â”€ Icons.lua             # Icon library
â”‚   â”œâ”€â”€ UIHelpers.lua         # UI utility functions
â”‚   â”œâ”€â”€ Notifications.lua     # Toast notification system
â”‚   â”œâ”€â”€ Hotkeys.lua           # Global hotkey management
â”‚   â”œâ”€â”€ KeySystem.lua         # ðŸ” NEW! Advanced key validation system
â”‚   â”œâ”€â”€ WindowManager.lua     # Multi-window coordination
â”‚   â”œâ”€â”€ Overlay.lua           # Overlay layer management (dropdowns, blockers)
â”‚   â”œâ”€â”€ WindowBuilder.lua     # Main window construction
â”‚   â”œâ”€â”€ TabBuilder.lua        # Tab construction
â”‚   â”œâ”€â”€ SectionBuilder.lua    # Section construction
â”‚   â””â”€â”€ Elements/             # All 10 UI elements
â”‚       â”œâ”€â”€ Button.lua
â”‚       â”œâ”€â”€ Toggle.lua
â”‚       â”œâ”€â”€ Dropdown.lua
â”‚       â”œâ”€â”€ Slider.lua
â”‚       â”œâ”€â”€ Keybind.lua
â”‚       â”œâ”€â”€ TextBox.lua
â”‚       â”œâ”€â”€ ColorPicker.lua
â”‚       â”œâ”€â”€ Label.lua
â”‚       â”œâ”€â”€ Paragraph.lua
â”‚       â””â”€â”€ Divider.lua
â”œâ”€â”€ init.lua                  # âœ… Modular entry point (bootstrap logic)
â”œâ”€â”€ build.js                  # âœ… Node build script
â”œâ”€â”€ build.lua                 # âœ… Lua fallback build script
â”œâ”€â”€ RvrseUI.lua               # âŒ GENERATED - Never edit directly!
â”œâ”€â”€ VERSION.json              # Version metadata & changelog
â”œâ”€â”€ README.md                 # User-facing documentation
â””â”€â”€ CLAUDE.md                 # This file (maintainer guide)
```

### Two Entry Points, Same Result

**1. Modular Mode** (`init.lua`)
- Used during development
- `require(script.init)` loads all modules separately
- Bootstrap logic lives in `init.lua`

**2. Monolith Mode** (`RvrseUI.lua`)
- Used for distribution via `loadstring(game:HttpGet(...))()`
- **Generated by build scripts** - combines all `src/` modules into one file
- **Now embeds the same bootstrap as `init.lua`** (as of v3.0.4)

---

## âš™ï¸ Build System Deep Dive

### How The Build Works

**`build.js` / `build.lua` perform these steps:**

1. **Read all modules** from `src/` in dependency order (25 modules total)
2. **Strip module headers** (comment lines starting with `--`)
3. **Convert local declarations to globals**: `local Module = {}` â†’ `Module = {}`
4. **Remove shadowing declarations**: Any `local RvrseUI` that would conflict
5. **Remove return statements**: `return ModuleName` at end of files
6. **Wrap in scoping blocks**: Each module wrapped in `do...end` block with indentation
7. **Initialize modules**: Bootstrap logic from `init.lua` (services, overlay, notifications)
8. **Inject RvrseUI public API**: 200+ lines from `init.lua` embedded at end
9. **Add return statement**: `return RvrseUI` so `loadstring()` works

**Exact module compilation order:**
```
Foundation: Version â†’ Debug â†’ Obfuscation
Data: Icons â†’ Theme
Systems: Animator â†’ State â†’ UIHelpers
Services: Config â†’ WindowManager â†’ Hotkeys â†’ Notifications â†’ KeySystem
Elements: Button â†’ Toggle â†’ Dropdown â†’ Slider â†’ Keybind â†’ TextBox â†’ ColorPicker â†’ Label â†’ Paragraph â†’ Divider
Builders: SectionBuilder â†’ TabBuilder â†’ WindowBuilder
```

**Module count: 27 total** (was 26 before KeySystem)

### Critical Build Rules

#### âœ… DO:
- Edit files in `src/` or `init.lua`
- Run `node build.js` after EVERY source change
- Commit both source files AND regenerated `RvrseUI.lua` together
- Test the compiled `RvrseUI.lua` in Roblox before pushing

#### âŒ DON'T:
- **NEVER** edit `RvrseUI.lua` directly
- **NEVER** skip the rebuild step
- **NEVER** commit source changes without rebuilding
- **NEVER** modify build scripts without understanding full impact

### Why Variable Scoping Matters

When compiling into ONE file, all modules share the same global scope:

```lua
-- âŒ BAD: This creates variable shadowing
local RvrseUI = {}        -- Line 24 (main table)
-- ... 1000 lines later ...
local RvrseUI = nil       -- Line 1728 (Notifications module)
-- âŒ This shadows the first one! Now RvrseUI is nil!
```

**Solution:** Build scripts remove conflicting `local RvrseUI` declarations:
```javascript
content.replace(/^local RvrseUI.*$/gm, '-- [Removed conflicting local RvrseUI]');
```

---

## ðŸš¨ Common Pitfalls & How We Fixed Them

### Mistake #1: Module Declarations Removed Entirely
**What Happened (v3.0.4 initial build):**
```javascript
// âŒ BROKEN - Removed entire declaration
content.replace(/local ([A-Z][A-Za-z]+) = \{\}/g, '');
// Result: "local Version = {}" â†’ "" (nothing!)
// Error: :33: attempt to index function with 'Data'
```

**Fix:**
```javascript
// âœ… FIXED - Convert to global, keep declaration
content.replace(/^local ([A-Z][A-Za-z]+) = \{\}/gm, '$1 = {}');
// Result: "local Version = {}" â†’ "Version = {}"
```

### Mistake #2: Missing Public API
**What Happened:**
- Build compiled all modules but never added RvrseUI methods
- `loadstring()` returned an empty `{}` table
- Error: `:12: attempt to index nil with 'EnableDebug'`

**Fix:**
- Extracted 200+ line API wrapper from `init.lua` (lines 162-350)
- Embedded it at the end of the build, before `return RvrseUI`
- All 24 public methods now properly exported

### Mistake #3: Variable Shadowing
**What Happened:**
- Notifications module had `local RvrseUI` at module level
- When compiled into one file, this shadowed main `local RvrseUI = {}`
- Error: `:5206: attempt to index nil with 'Version'`

**Fix:**
- Build scripts now remove all conflicting `local RvrseUI` declarations
- Only ONE `local RvrseUI = {}` exists (at line 24)

---

## ðŸ“‹ Strict Development Workflow

### Making Source Changes

```bash
# 1. Edit source files
vim src/WindowBuilder.lua

# 2. Rebuild the monolith
node build.js

# 3. Test in Roblox
# Load the generated RvrseUI.lua and verify changes work

# 4. Commit both source and compiled together
git add src/WindowBuilder.lua RvrseUI.lua
git commit -m "feat: add feature X"
git push origin main
```

### Version Bumps (Complete Checklist)

When releasing a new version, update ALL these files:

```bash
# 1. VERSION.json
{
  "version": {
    "patch": 4,           # Increment
    "full": "3.0.4",      # Update
    "build": "20251010",  # YYYYMMDD
    "hash": "K7M3P9X1"    # New random hash
  },
  "changelog": {
    "3.0.4": {            # Add new entry
      "changes": [...]
    }
  }
}

# 2. README.md
![Version](https://img.shields.io/badge/version-3.0.4-blue)
local VERSION = "v3.0.4"

# 3. CLAUDE.md (header)
# RvrseUI â€“ Maintainer Notes (v4.0.0)

# 4. src/Version.lua
Version.Data = {
  Patch = 4,
  Full = "3.0.4",
  Build = "20251010",
  Hash = "K7M3P9X1"
}

# 5. build.js and build.lua (version banners)
console.log('ðŸ”¨ RvrseUI v3.0.4 Build Script');
const header = `-- RvrseUI v3.0.4 | Modern Professional UI Framework

# 6. Rebuild
node build.js

# 7. Commit everything together
git add VERSION.json README.md CLAUDE.md src/Version.lua build.js build.lua RvrseUI.lua
git commit -m "chore: bump version to v3.0.4"
git push origin main
```

**âš ï¸ The pre-push hook will block if version files are inconsistent!**

---

## ðŸ”§ Module-Specific Rules

### Configuration Persistence Lockdown
- Save/load now routes through the live `RvrseUI` context (`src/Config.lua`) so every flagged element serializes correctly.
- Theme cache (`_savedTheme`) is synced back to the active window; do not strip this hand-off.
- Boolean `ConfigurationSaving = true` reuses the last profile by splitting `folder/file.json`; keep this parsing intact.
- `ConfigurationSaving.AutoSave = false` disables background writes; keep `_autoSave` guard in sync if you extend persistence.
- Profiles tab auto-injects when configuration saving is enabled; customise via `ConfigurationManager` or disable it entirely when embedding bespoke controls.
- When touching persistence code, verify the executor supports `writefile/readfile/isfile` and rerun a full save â†’ load cycle with all 12 elements.

### Profiles Tab Behaviours
- Dropdown always re-scans on open and after Save/Save As/Delete; do not reintroduce cached lists.
- `SetConfigProfile` now updates the in-memory context and `_lastContext`; keep this when adding profile shortcuts.
- Deleting the active profile clears selection and labelsâ€”ensure any future UI also handles this case.
- Auto-save toggle mirrors `RvrseUI:SetAutoSaveEnabled`; avoid writing alternate toggles that bypass the guard.

### Window & Chip Drag System (v3.0.4)
- **Advanced cursor-locked drag** with grab-offset caching ensures cursor stays glued to exact grab point
- Window header drag handles GUI inset for all host types (`IgnoreGuiInset = true/false`)
- Controller chip drag uses `AnchorPoint (0.5, 0.5)` for center-based positioning
- Both systems use sub-pixel precision: `math.floor(value + 0.5)`
- Debug logging throughout: `Debug.printf("[DRAG] ...")` and `Debug.printf("[CHIP DRAG] ...")`
- If you change the host container, update inset logic in `WindowBuilder` accordingly

### Overlay Layer & Dropdowns (`src/Overlay.lua`)
- Dedicated `Overlay` module manages the overlay layer, initialized in both `init.lua` and the monolith bootstrap.
- `Overlay:Initialize()` creates `RvrseUI_Overlay` Frame with `ZIndex = 20000` on a separate ScreenGui.
- `Overlay:GetLayer()` returns the overlay Frame for dropdown/popup parenting.
- Dropdown element default is `Overlay = true`; set `Overlay = false` for legacy inline menus.
- Overlay mode requires the blocker to close menusâ€”preserve `ensureBlocker()` and `setOpen(false)` patterns when extending.
- The overlay layer is kept transparent and hidden when idle; dropdowns show/hide it as needed.
- When adding new overlay elements, use `deps.OverlayLayer` (from WindowBuilder) to ensure consistent z-ordering.

### Monolith Build Pipeline
- `build.js` / `build.lua` wrap each module in a `do ... end` scope with tab indentation before concatenation.
- Bootstrap logic from `init.lua` is embedded into the monolith (lines 138-232 of build scripts):
  - Initializes all modules in dependency order
  - Creates `DEFAULT_HOST` ScreenGui (DisplayOrder = 999)
  - Creates `DEFAULT_OVERLAY` Frame (ZIndex = 20000) via inline code (Overlay module not used in bootstrap)
  - Initializes Notifications, Hotkeys, WindowManager
  - Sets up Elements table with all 10 element types
- The compiled `RvrseUI.lua` is standalone: safe to `loadstring()` without external dependencies.
- Any edits in `src/` or `init.lua` must be followed by `node build.js` (or `lua build.lua`) to keep the monolith aligned.
- **NEVER patch `RvrseUI.lua` directly** - it will be overwritten on next build.
- The compiled file caches `DEFAULT_HOST` / `DEFAULT_OVERLAY`. If destroyed manually, `RvrseUI:CreateWindow` recreates them (lines 293-300 of build scripts).
- Version bumps require updating `VERSION.json`, README badge, CLAUDE.md header, and rerunning build for timestamp update.

### Hotkey Pipeline
- `Hotkeys:Initialize` immediately wires `InputBegan` and prevents double hookups. Ensure any future hotkey changes toggle `_initialized` carefully.

### KeySystem (`src/KeySystem.lua`) - v4.0.0 NEW!
- **737-line advanced key validation system** with multiple authentication methods
- Blocks `CreateWindow` execution until key validated or max attempts exhausted
- **CRITICAL**: All animations use `Animator:Tween()` not `Animator:Spring()` (Spring is a table, not method!)
- Theme colors accessed via `deps.Theme:Get()` which returns the palette table (not `Theme.Current` which is a string!)
- Obfuscation uses `:Generate()` method, not `:Obfuscate()`

#### Key System Architecture
- **UI Design**: 500px wide container, gradient header with ðŸ” icon, animated rotating border gradient, modern rounded corners (16px)
- **Validation Methods** (4 types):
  1. Simple string key (`Key = "string"`) - Rayfield compatible
  2. Multiple keys (`Keys = {"key1", "key2"}`) - RvrseUI extension
  3. HWID/User ID whitelist (`Whitelist = {"123", "HWID-ABC"}`)
  4. Custom validator function (`Validator = function(key) return boolean end`)
- **Remote Key Fetching**: `GrabKeyFromSite = true` + URL in `Key` parameter
- **File Persistence**: Saves validated keys to `RvrseUI/KeySystem/{FileName}.key`
- **Attempt Limiting**: Configurable `MaxAttempts` (default 3)
- **Graceful Failure**: Returns dummy window object on validation failure (prevents script crashes)
- **Discord Logging**: Optional webhook integration logs all attempts with user info
- **Callbacks**: `OnKeyValid`, `OnKeyInvalid`, `OnAttemptsExhausted` for custom behavior

#### Integration with WindowBuilder
- KeySystem validation runs **BEFORE** window creation in `WindowBuilder:CreateWindow()`
- If validation fails and `KickOnFailure = false`, a **dummy window object** is returned with no-op methods
- Dummy window prevents `attempt to index nil` errors when user script tries to call `Window:CreateTab()`
- All dummy methods return empty tables so script continues without crashing
- Warning logged: `[RvrseUI] Key validation failed - Window creation blocked`

#### Common KeySystem Pitfalls
1. **Animation Method Error** - Use `Animator:Tween(obj, props, info)` not `Animator:Spring()`
2. **Theme Access** - Use `deps.Theme:Get()` to get color palette table
3. **Color Properties** - Theme palette uses: `Bg`, `Text`, `TextSub`, `TextMuted`, `Surface`, `Accent`, `AccentHover`, `Success`, `Error`, `Warning`
4. **Nil Message Handling** - Always use `tostring(message or "default")` when logging validation results
5. **Dummy Window Pattern** - Must return full dummy object tree (Window â†’ Tab â†’ Section â†’ Elements) to prevent crashes

#### KeySystem Testing
```lua
-- Test lockout behavior (wrong keys)
RvrseUI:CreateWindow({
    KeySystem = true,
    KeySettings = {
        Keys = {"TestKey123"},
        MaxAttempts = 3,
        KickOnFailure = false,  -- Don't kick to test dummy window
        OnKeyInvalid = function(key, attemptsLeft)
            print("âŒ INVALID:", key, "| Left:", attemptsLeft)
        end,
        OnAttemptsExhausted = function()
            print("âš ï¸ LOCKOUT! No attempts remaining")
        end
    }
})
-- Enter 3 wrong keys â†’ Lockout â†’ Dummy window returned â†’ Script continues
```

### Debug & Version Helpers
- `Debug.printf` is relied on throughout `WindowBuilder`; keep it exported when refactoring the debug module.
- `Version` exposes fields via metatableâ€”always update `Version.Data` rather than reassigning properties directly.

### Dependency Injection Pattern
- **All builders use dependency injection** via `Initialize(deps)` method.
- The `deps` table is assembled in `init.lua` (lines 126-152) and contains:
  - Modules: Theme, Animator, State, Config, UIHelpers, Icons, etc.
  - Services: UserInputService, GuiService, RunService, TweenService, HttpService
  - Builders: TabBuilder, SectionBuilder, WindowBuilder
  - Elements: Table of all 10 element constructors
  - OverlayLayer: Reference to overlay Frame
- **In the monolith**, deps is constructed inline in `RvrseUI:CreateWindow()` (build scripts lines 247-269).
- **NEVER use global lookups** in modules - always accept dependencies via Initialize or function parameters.
- When adding new modules, follow the pattern:
  ```lua
  local Module = {}
  local deps

  function Module:Initialize(dependencies)
      deps = dependencies
  end

  function Module:DoSomething()
      -- Use deps.Theme, deps.Animator, etc.
      deps.Theme:Switch("Dark")
  end
  ```

---

## ðŸ§ª Testing & Validation

### Quick Validation Checklist
1. Toggle each element flag, call `SaveConfiguration`, restart script, confirm values restore.
2. If auto-save is disabled, ensure manual saves still write expected profiles.
3. Minimize to the ðŸŽ® chip, drag around edges, restore, then destroy via `Escape`.
4. Open dropdowns on top of dense layouts and verify overlay blockers close them.
5. Confirm `ToggleUIKeybind` still acts globally after any hotkey changes.
6. Run docs build (README badge/version) when bumping releases.

### Testing Drag Systems
```lua
-- Enable debug mode to see drag logging
RvrseUI:EnableDebug(true)

-- Test window header drag
-- 1. Click anywhere on the header
-- 2. Drag - cursor should stay locked to exact grab point
-- 3. Check console for: "[DRAG] Cached offset: X=..., Y=..."

-- Test controller chip drag
-- 1. Minimize window
-- 2. Click on ðŸŽ® chip
-- 3. Drag - chip should follow cursor perfectly from grab point
-- 4. Check console for: "[CHIP DRAG] Cached grab offset: X=..., Y=..."
```

---

## ðŸš‘ Troubleshooting Common Errors

### Error: `attempt to index function with 'Data'`
**Cause:** Module declaration was removed entirely
**Fix:** Check build scripts convert `local Module = {}` â†’ `Module = {}`

### Error: `attempt to index nil with 'EnableDebug'`
**Cause:** RvrseUI public API not embedded in build
**Fix:** Verify build scripts include the `rvrseUIAPI` wrapper before `return RvrseUI`

### Error: `attempt to index nil with 'Version'`
**Cause:** Variable shadowing - conflicting `local RvrseUI` declarations
**Fix:** Build scripts should remove all `local RvrseUI` except the main one on line 24

### Build Produces 0 KB File
**Cause:** Syntax error in source or build script
**Fix:** Check build script output for errors, verify all modules compile individually

### Changes Don't Appear After Rebuild
**Cause:** Cached old version or didn't rebuild
**Fix:** Run `node build.js` again, check file timestamp, clear Roblox cache

---

## ðŸŽ¯ AI Assistant Guidelines

If you're an AI (like Claude or GPT) working on this project:

### BEFORE Making Changes:
1. âœ… Read `CLAUDE.md` (this file) completely
2. âœ… Read `README.md` to understand user-facing features
3. âœ… Check `VERSION.json` for current version and changelog
4. âœ… Review the specific `src/` files you plan to modify

### WHEN Making Changes:
1. âœ… Only edit files in `src/` or `init.lua`
2. âœ… Never directly edit `RvrseUI.lua`
3. âœ… Always rebuild after source changes: `node build.js`
4. âœ… Test the compiled output before committing
5. âœ… Commit source + compiled together

### AFTER Making Changes:
1. âœ… Verify the build produced no errors
2. âœ… Check file size is reasonable (~150 KB)
3. âœ… Test in Roblox if possible
4. âœ… Update version files if releasing
5. âœ… Document breaking changes in VERSION.json changelog

### RED FLAGS (Stop and Ask):
- ðŸš¨ You want to edit `RvrseUI.lua` directly
- ðŸš¨ You want to skip the rebuild step
- ðŸš¨ You're adding `local RvrseUI` anywhere
- ðŸš¨ You're modifying build script regex without testing
- ðŸš¨ You're changing module initialization order
- ðŸš¨ You're removing or renaming `Debug.printf` calls

---

## ðŸ“š Additional Resources

- **User Documentation:** `README.md`
- **Version History:** `VERSION.json` (changelog section)
- **Archived Tests:** `docs/__archive/2025-10-09/TEST_ALL_FEATURES.lua`
- **GitHub Repository:** https://github.com/CoderRvrse/RvrseUI
- **GitHub Issues:** https://github.com/CoderRvrse/RvrseUI/issues

## ðŸ› ï¸ Common Development Commands

### Building the Monolith
```bash
# Build with Node.js (preferred)
node build.js

# Build with Lua (fallback)
lua build.lua
```

### Testing
```bash
# Test in Roblox Studio
# 1. Load init.lua as a ModuleScript under ReplicatedStorage
# 2. Require it from a LocalScript
# 3. Verify all features work

# Test compiled monolith
# 1. Copy RvrseUI.lua content
# 2. Use loadstring(game:HttpGet(...))() in Roblox
# 3. Verify all features work
```

### Version Management
```bash
# Update version across all files (manual process)
# 1. Edit VERSION.json (version.patch, version.full, version.build, version.hash)
# 2. Edit README.md (badge and example code)
# 3. Edit CLAUDE.md (header)
# 4. Edit src/Version.lua (Version.Data table)
# 5. Edit build.js and build.lua (header comments)
# 6. Run: node build.js
# 7. Commit all changes together
```

### Git Workflow
```bash
# Standard workflow
git add src/ModuleName.lua RvrseUI.lua  # Always commit source + compiled together
git commit -m "feat: description"
git push origin main

# Version release workflow
git add VERSION.json README.md CLAUDE.md src/Version.lua build.js build.lua RvrseUI.lua
git commit -m "chore: bump version to v3.0.X"
git push origin main
```

---

## ðŸ”’ Final Reminder

> **This project has a sophisticated build system that can break in subtle ways.**
> **Follow the documented workflow strictly.**
> **When in doubt, ask before changing core files.**
> **Test thoroughly before pushing to main.**

**Last Updated:** 2025-10-10 (v3.0.4 - Cursor-Locked Drag Release)

---

## ðŸ“Š Module Statistics

- **Total Modules:** 25 (not 26 - documentation error in older versions)
  - Foundation: 3 (Version, Debug, Obfuscation)
  - Data: 2 (Icons, Theme)
  - Systems: 3 (Animator, State, UIHelpers)
  - Services: 5 (Config, WindowManager, Hotkeys, Notifications, Overlay)
  - Elements: 10 (Button, Toggle, Dropdown, Slider, Keybind, TextBox, ColorPicker, Label, Paragraph, Divider)
  - Builders: 3 (SectionBuilder, TabBuilder, WindowBuilder)
- **Element Count:** 10 UI elements (not 12 - documentation referenced future elements)
- **Total Lines (compiled):** ~5,500 lines in RvrseUI.lua
- **File Size:** ~166 KB (RvrseUI.lua monolith)
