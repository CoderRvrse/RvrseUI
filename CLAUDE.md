# RvrseUI ‚Äì Maintainer Notes (v3.0.4)

> **‚ö†Ô∏è CRITICAL: Read this entire document before making ANY changes to the codebase.**
> This file documents the architecture, build system, common pitfalls, and strict workflows that MUST be followed.

---

## üèóÔ∏è Architecture Overview

### File Structure
```
RvrseUI/
‚îú‚îÄ‚îÄ src/                      # ‚úÖ SOURCE OF TRUTH - Edit these files
‚îÇ   ‚îú‚îÄ‚îÄ Version.lua           # Version metadata
‚îÇ   ‚îú‚îÄ‚îÄ Debug.lua             # Debug logging system
‚îÇ   ‚îú‚îÄ‚îÄ Theme.lua             # Dark/Light palettes
‚îÇ   ‚îú‚îÄ‚îÄ Animator.lua          # Spring animations
‚îÇ   ‚îú‚îÄ‚îÄ WindowBuilder.lua     # Main window construction
‚îÇ   ‚îú‚îÄ‚îÄ Config.lua            # Persistence system
‚îÇ   ‚îî‚îÄ‚îÄ Elements/             # All 12 UI elements
‚îú‚îÄ‚îÄ init.lua                  # ‚úÖ Modular entry point (bootstrap logic)
‚îú‚îÄ‚îÄ build.js                  # ‚úÖ Node build script
‚îú‚îÄ‚îÄ build.lua                 # ‚úÖ Lua fallback build script
‚îú‚îÄ‚îÄ RvrseUI.lua               # ‚ùå GENERATED - Never edit directly!
‚îú‚îÄ‚îÄ VERSION.json              # Version metadata & changelog
‚îú‚îÄ‚îÄ README.md                 # User-facing documentation
‚îî‚îÄ‚îÄ CLAUDE.md                 # This file (maintainer guide)
```

### Two Entry Points, Same Result

**1. Modular Mode** (`init.lua`)
- Used during development
- `require(script.init)` loads all modules separately
- Bootstrap logic lives in `init.lua`

**2. Monolith Mode** (`RvrseUI.lua`)
- Used for distribution via `loadstring(game:HttpGet(...))()`
- **Generated by build scripts** - combines all `src/` modules into one file
- **Now embeds the same bootstrap as `init.lua`** (as of v3.0.4)

---

## ‚öôÔ∏è Build System Deep Dive

### How The Build Works

**`build.js` / `build.lua` perform these steps:**

1. **Read all modules** from `src/` in dependency order
2. **Strip module headers** (comment lines starting with `--`)
3. **Convert local declarations to globals**: `local Module = {}` ‚Üí `Module = {}`
4. **Remove shadowing declarations**: Any `local RvrseUI` that would conflict
5. **Remove return statements**: `return ModuleName` at end of files
6. **Wrap in scoping blocks**: Each module in `do...end` (optional, not currently used)
7. **Inject RvrseUI public API**: 200+ lines from `init.lua` embedded at end
8. **Add return statement**: `return RvrseUI` so `loadstring()` works

### Critical Build Rules

#### ‚úÖ DO:
- Edit files in `src/` or `init.lua`
- Run `node build.js` after EVERY source change
- Commit both source files AND regenerated `RvrseUI.lua` together
- Test the compiled `RvrseUI.lua` in Roblox before pushing

#### ‚ùå DON'T:
- **NEVER** edit `RvrseUI.lua` directly
- **NEVER** skip the rebuild step
- **NEVER** commit source changes without rebuilding
- **NEVER** modify build scripts without understanding full impact

### Why Variable Scoping Matters

When compiling into ONE file, all modules share the same global scope:

```lua
-- ‚ùå BAD: This creates variable shadowing
local RvrseUI = {}        -- Line 24 (main table)
-- ... 1000 lines later ...
local RvrseUI = nil       -- Line 1728 (Notifications module)
-- ‚ùå This shadows the first one! Now RvrseUI is nil!
```

**Solution:** Build scripts remove conflicting `local RvrseUI` declarations:
```javascript
content.replace(/^local RvrseUI.*$/gm, '-- [Removed conflicting local RvrseUI]');
```

---

## üö® Common Pitfalls & How We Fixed Them

### Mistake #1: Module Declarations Removed Entirely
**What Happened (v3.0.4 initial build):**
```javascript
// ‚ùå BROKEN - Removed entire declaration
content.replace(/local ([A-Z][A-Za-z]+) = \{\}/g, '');
// Result: "local Version = {}" ‚Üí "" (nothing!)
// Error: :33: attempt to index function with 'Data'
```

**Fix:**
```javascript
// ‚úÖ FIXED - Convert to global, keep declaration
content.replace(/^local ([A-Z][A-Za-z]+) = \{\}/gm, '$1 = {}');
// Result: "local Version = {}" ‚Üí "Version = {}"
```

### Mistake #2: Missing Public API
**What Happened:**
- Build compiled all modules but never added RvrseUI methods
- `loadstring()` returned an empty `{}` table
- Error: `:12: attempt to index nil with 'EnableDebug'`

**Fix:**
- Extracted 200+ line API wrapper from `init.lua` (lines 162-350)
- Embedded it at the end of the build, before `return RvrseUI`
- All 24 public methods now properly exported

### Mistake #3: Variable Shadowing
**What Happened:**
- Notifications module had `local RvrseUI` at module level
- When compiled into one file, this shadowed main `local RvrseUI = {}`
- Error: `:5206: attempt to index nil with 'Version'`

**Fix:**
- Build scripts now remove all conflicting `local RvrseUI` declarations
- Only ONE `local RvrseUI = {}` exists (at line 24)

---

## üìã Strict Development Workflow

### Making Source Changes

```bash
# 1. Edit source files
vim src/WindowBuilder.lua

# 2. Rebuild the monolith
node build.js

# 3. Test in Roblox
# Load the generated RvrseUI.lua and verify changes work

# 4. Commit both source and compiled together
git add src/WindowBuilder.lua RvrseUI.lua
git commit -m "feat: add feature X"
git push origin main
```

### Version Bumps (Complete Checklist)

When releasing a new version, update ALL these files:

```bash
# 1. VERSION.json
{
  "version": {
    "patch": 4,           # Increment
    "full": "3.0.4",      # Update
    "build": "20251010",  # YYYYMMDD
    "hash": "K7M3P9X1"    # New random hash
  },
  "changelog": {
    "3.0.4": {            # Add new entry
      "changes": [...]
    }
  }
}

# 2. README.md
![Version](https://img.shields.io/badge/version-3.0.4-blue)
local VERSION = "v3.0.4"

# 3. CLAUDE.md (header)
# RvrseUI ‚Äì Maintainer Notes (v3.0.4)

# 4. src/Version.lua
Version.Data = {
  Patch = 4,
  Full = "3.0.4",
  Build = "20251010",
  Hash = "K7M3P9X1"
}

# 5. build.js and build.lua (version banners)
console.log('üî® RvrseUI v3.0.4 Build Script');
const header = `-- RvrseUI v3.0.4 | Modern Professional UI Framework

# 6. Rebuild
node build.js

# 7. Commit everything together
git add VERSION.json README.md CLAUDE.md src/Version.lua build.js build.lua RvrseUI.lua
git commit -m "chore: bump version to v3.0.4"
git push origin main
```

**‚ö†Ô∏è The pre-push hook will block if version files are inconsistent!**

---

## üîß Module-Specific Rules

### Configuration Persistence Lockdown
- Save/load now routes through the live `RvrseUI` context (`src/Config.lua`) so every flagged element serializes correctly.
- Theme cache (`_savedTheme`) is synced back to the active window; do not strip this hand-off.
- Boolean `ConfigurationSaving = true` reuses the last profile by splitting `folder/file.json`; keep this parsing intact.
- `ConfigurationSaving.AutoSave = false` disables background writes; keep `_autoSave` guard in sync if you extend persistence.
- Profiles tab auto-injects when configuration saving is enabled; customise via `ConfigurationManager` or disable it entirely when embedding bespoke controls.
- When touching persistence code, verify the executor supports `writefile/readfile/isfile` and rerun a full save ‚Üí load cycle with all 12 elements.

### Profiles Tab Behaviours
- Dropdown always re-scans on open and after Save/Save As/Delete; do not reintroduce cached lists.
- `SetConfigProfile` now updates the in-memory context and `_lastContext`; keep this when adding profile shortcuts.
- Deleting the active profile clears selection and labels‚Äîensure any future UI also handles this case.
- Auto-save toggle mirrors `RvrseUI:SetAutoSaveEnabled`; avoid writing alternate toggles that bypass the guard.

### Window & Chip Drag System (v3.0.4)
- **Advanced cursor-locked drag** with grab-offset caching ensures cursor stays glued to exact grab point
- Window header drag handles GUI inset for all host types (`IgnoreGuiInset = true/false`)
- Controller chip drag uses `AnchorPoint (0.5, 0.5)` for center-based positioning
- Both systems use sub-pixel precision: `math.floor(value + 0.5)`
- Debug logging throughout: `Debug.printf("[DRAG] ...")` and `Debug.printf("[CHIP DRAG] ...")`
- If you change the host container, update inset logic in `WindowBuilder` accordingly

### Overlay Layer & Dropdowns
- `init.lua` provisions `RvrseUI_Overlay`; reuse it for any future popovers so stacking order stays predictable.
- Dropdown element default is `Overlay = true`; set `Overlay = false` for legacy inline menus.
- Overlay mode requires the blocker to close menus‚Äîpreserve `ensureBlocker()` and `setOpen(false)` patterns when extending.
- When adding new overlay elements, clamp to `OverlayLayer.ZIndex` ‚â• 200 to keep them above the base window.

### Monolith Build Pipeline
- `build.js` / `build.lua` now wrap each module in a `do ... end` scope before concatenation and immediately execute the same bootstrap logic as `init.lua`. This pre-creates the default ScreenGui (`DEFAULT_HOST`), overlay frame, notifications, hotkeys, and window manager so `RvrseUI.lua` is safe to run standalone.
- Any edits in `src/` or `init.lua` must be followed by `node build.js` (or `lua build.lua` where available) to keep the monolith aligned. Never patch `RvrseUI.lua` directly.
- The compiled file caches `_DEFAULT_HOST` / `_DEFAULT_OVERLAY`. If a consumer destroys the ScreenGui manually, `RvrseUI:CreateWindow` will recreate it and reinitialise notifications on demand‚Äîretain that guard when touching the builder.
- Version bumps require updating `VERSION.json`, refreshing the README badge, and rerunning the build so the header comment reflects the new timestamp.

### Hotkey Pipeline
- `Hotkeys:Initialize` immediately wires `InputBegan` and prevents double hookups. Ensure any future hotkey changes toggle `_initialized` carefully.

### Debug & Version Helpers
- `Debug.printf` is relied on throughout `WindowBuilder`; keep it exported when refactoring the debug module.
- `Version` exposes fields via metatable‚Äîalways update `Version.Data` rather than reassigning properties directly.

---

## üß™ Testing & Validation

### Quick Validation Checklist
1. Toggle each element flag, call `SaveConfiguration`, restart script, confirm values restore.
2. If auto-save is disabled, ensure manual saves still write expected profiles.
3. Minimize to the üéÆ chip, drag around edges, restore, then destroy via `Escape`.
4. Open dropdowns on top of dense layouts and verify overlay blockers close them.
5. Confirm `ToggleUIKeybind` still acts globally after any hotkey changes.
6. Run docs build (README badge/version) when bumping releases.

### Testing Drag Systems
```lua
-- Enable debug mode to see drag logging
RvrseUI:EnableDebug(true)

-- Test window header drag
-- 1. Click anywhere on the header
-- 2. Drag - cursor should stay locked to exact grab point
-- 3. Check console for: "[DRAG] Cached offset: X=..., Y=..."

-- Test controller chip drag
-- 1. Minimize window
-- 2. Click on üéÆ chip
-- 3. Drag - chip should follow cursor perfectly from grab point
-- 4. Check console for: "[CHIP DRAG] Cached grab offset: X=..., Y=..."
```

---

## üöë Troubleshooting Common Errors

### Error: `attempt to index function with 'Data'`
**Cause:** Module declaration was removed entirely
**Fix:** Check build scripts convert `local Module = {}` ‚Üí `Module = {}`

### Error: `attempt to index nil with 'EnableDebug'`
**Cause:** RvrseUI public API not embedded in build
**Fix:** Verify build scripts include the `rvrseUIAPI` wrapper before `return RvrseUI`

### Error: `attempt to index nil with 'Version'`
**Cause:** Variable shadowing - conflicting `local RvrseUI` declarations
**Fix:** Build scripts should remove all `local RvrseUI` except the main one on line 24

### Build Produces 0 KB File
**Cause:** Syntax error in source or build script
**Fix:** Check build script output for errors, verify all modules compile individually

### Changes Don't Appear After Rebuild
**Cause:** Cached old version or didn't rebuild
**Fix:** Run `node build.js` again, check file timestamp, clear Roblox cache

---

## üéØ AI Assistant Guidelines

If you're an AI (like Claude or GPT) working on this project:

### BEFORE Making Changes:
1. ‚úÖ Read `CLAUDE.md` (this file) completely
2. ‚úÖ Read `README.md` to understand user-facing features
3. ‚úÖ Check `VERSION.json` for current version and changelog
4. ‚úÖ Review the specific `src/` files you plan to modify

### WHEN Making Changes:
1. ‚úÖ Only edit files in `src/` or `init.lua`
2. ‚úÖ Never directly edit `RvrseUI.lua`
3. ‚úÖ Always rebuild after source changes: `node build.js`
4. ‚úÖ Test the compiled output before committing
5. ‚úÖ Commit source + compiled together

### AFTER Making Changes:
1. ‚úÖ Verify the build produced no errors
2. ‚úÖ Check file size is reasonable (~150 KB)
3. ‚úÖ Test in Roblox if possible
4. ‚úÖ Update version files if releasing
5. ‚úÖ Document breaking changes in VERSION.json changelog

### RED FLAGS (Stop and Ask):
- üö® You want to edit `RvrseUI.lua` directly
- üö® You want to skip the rebuild step
- üö® You're adding `local RvrseUI` anywhere
- üö® You're modifying build script regex without testing
- üö® You're changing module initialization order
- üö® You're removing or renaming `Debug.printf` calls

---

## üìö Additional Resources

- **User Documentation:** `README.md`
- **Version History:** `VERSION.json` (changelog section)
- **Archived Tests:** `docs/__archive/2025-10-09/TEST_ALL_FEATURES.lua`
- **GitHub Issues:** https://github.com/CoderRvrse/RvrseUI/issues

---

## üîí Final Reminder

> **This project has a sophisticated build system that can break in subtle ways.**
> **Follow the documented workflow strictly.**
> **When in doubt, ask before changing core files.**
> **Test thoroughly before pushing to main.**

**Last Updated:** 2025-10-10 (v3.0.4 - Cursor-Locked Drag Release)
